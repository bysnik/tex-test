# .github/workflows/build-pdf.yml
name: üìÑ –°–±–æ—Ä–∫–∞ —ç–∫–∑–∞–º–µ–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ –≤ PDF

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

permissions:
  contents: write # —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –¥—Ä—É–≥–æ–π –±—Ä–∞–Ω—á

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ—Ç–∫–∞–º–∏

      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TeX Live (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è)
        uses: xu-cheng/latex-action@v3
        with:
          distribution: tinytex
          packages: |
            array
            needspace
            float
            babel-russian
            fontenc
            inputenc
            geometry
          root_file: tickets.tex # –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ –ª—é–±–æ–π .tex –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞

      - name: üîç –ü–æ–∏—Å–∫ –∏ –∫–æ–º–ø–∏–ª—è—Ü–∏—è –≤—Å–µ—Ö .tex —Ñ–∞–π–ª–æ–≤ –±–∏–ª–µ—Ç–æ–≤
        run: |
          # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          mkdir -p compiled-pdfs

          # –ò—â–µ–º –≤—Å–µ .tex —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞—è –ø—Ä–µ–∞–º–±—É–ª—É –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ)
          find . -maxdepth 1 -name "*.tex" -not -name "preamble.tex" -not -name "main.tex" | while read texfile; do
            filename=$(basename "$texfile" .tex)
            echo "–ö–æ–º–ø–∏–ª–∏—Ä—É—é: $filename.tex ‚Üí $filename.pdf"

            # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≤ 2 –ø—Ä–æ—Ö–æ–¥–∞ (–¥–ª—è —Å—Å—ã–ª–æ–∫/–æ–≥–ª–∞–≤–ª–µ–Ω–∏—è)
            latexmk -pdf -interaction=nonstopmode -output-directory=compiled-pdfs "$texfile" || {
              echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ $filename.tex, –ø—Ä–æ–±—É–µ–º –≤—Ç–æ—Ä–æ–π —Ä–∞–∑..."
              latexmk -pdf -interaction=nonstopmode -output-directory=compiled-pdfs "$texfile" || {
                echo "‚ùå –ü–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ $filename.tex"
                exit 1
              }
            }

            # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ—Ä–µ–Ω—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (—É–±–∏—Ä–∞–µ–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
            mv "compiled-pdfs/${filename}.pdf" "compiled-pdfs/" 2>/dev/null || true
          done

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ö–æ—Ç—å –æ–¥–∏–Ω PDF —Å–æ–∑–¥–∞–Ω
          if [ ! -f compiled-pdfs/*.pdf ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ PDF"
            exit 1
          fi

          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          ls -lh compiled-pdfs/

      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è PDF –≤ –±—Ä–∞–Ω—á pdf-output
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: pdf-output          # —Ü–µ–ª–µ–≤–æ–π –±—Ä–∞–Ω—á
          publish_dir: ./compiled-pdfs        # –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å PDF
          keep_files: true                    # —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          commit_message: "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤: ${{ github.sha }}"
          force_orphan: false                 # –Ω–µ —É–¥–∞–ª—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤
